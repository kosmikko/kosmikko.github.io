<!DOCTYPE html><html lang="en"><head><!-- Meta--><meta charset="utf-8"><meta http-equiv="content-type" content="text/html; charset=utf-8"><title>Jenkins setup for a JavaScript project | mikkolehtinen.com</title><meta name="description" content="Mikko Lehtinen | @kosmikko · Technical Blog on JavaScript, Backbone.js, Node.js, Python, etc."><meta name="keywords" content="javascript, backbonejs, python"><meta name="author" content="Mikko Lehtinen"><meta http-equiv="X-Powered-By" content="DocPad"/><meta name="viewport" content="width=device-width"><!-- Icons--><link rel="shortcut icon" href="img/favicon.png"><!--[if lt IE 9]><script async src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]--><!-- Styles--><link rel="stylesheet" href="/styles/monokai.css" /><link rel="stylesheet" href="/styles/main.css" /><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" type="text/css"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" type="text/css"><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', "UA-18743700-1"]);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body><header class="logo"><hgroup><h1><a href="/">mikkolehtinen.com</a></h1></hgroup></header><article id="maincolumn"><section id="content" class="content"><article class="post"><header><h1><a href="/blog/2013-01-31-jenkins-setup-for-a-javascript-project">Jenkins setup for a JavaScript project</a></h1><p class="meta">Jan 31 2013</p></header><div class="page-content"><p>Jenkins is a fairly nice self-hosted CI server, fit for most uses. It&#39;s not perfect though: UI is rather ugly reminiscent from the early 00s, it has enterprisey feeling due to its Java focus, and it can be resource hog at times. But nevertheless Jenkins is easy to setup, it is very flexible and has plugins for most needs.

</p>
<p>In this tutorial I&#39;ll show an example on how we did setup Jenkins as CI server for our JavaScript app at <a href="http://www.applifier.com/">Applifier</a>. Our app consists of APIs written using Node.js and frontend using Backbone.js, but most of this is valid for any tech. 

</p>
<p>Let’s skip the basic Jenkins setup, there’s plenty of <a href="http://nepalonrails.com/post/14217655627/set-up-jenkins-ci-on-ubuntu-for-painless-rails3-app-ci">tutorials</a> for that. Come back after you&#39;ve installed Jenkins and configured basics such as security (e.g. <a href="http://wiki.jenkins-ci.org/display/JENKINS/Role+Strategy+Plugin">role-based</a> strategy is quite simple to setup).

</p>
<h3>Required Plugins:</h3>
<p>For this tutorial you need the following plugins:

</p>
<ul>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/Github+Plugin">GitHub plugin</a></li>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/Cobertura+Plugin">Jenkins Cobertura Plugin</a></li>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/TAP+Plugin">Jenkins TAP Plugin</a></li>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/Violations">Jenkins Violations plugin</a></li>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/Email-ext+plugin">Jenkins Email Extension Plugin</a></li>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/HTML+Publisher+Plugin">HTML Publisher plugin</a></li>
<li><a href="https://wiki.jenkins-ci.org/display/JENKINS/Checkstyle+Plugin">Checkstyle Plug-in</a></li>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/Join+Plugin">Join plugin</a></li>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/Flexible+Publish+Plugin">Flexible Publish Plugin</a></li>
</ul>
<h2>Create a new job</h2>
<p>Creating a new job is simple:
- Click &#39;New Job&#39; link on the left.
- Usually you&#39;ll want to choose <em>Build a free-style software project</em> or <em>Copy existing Job</em> in order to copy configuration from an existing job.
- Give it a descriptive name in <em>Job name</em> text input. It&#39;s good to have a naming convention e.g. <em>project-name-job-description</em>. For example &#39;admin-client-unit-tests&#39;

</p>
<p><img src="/blogimages/new-job.png" alt="New job">

</p>
<h3>Configure basics</h3>
<ul>
<li>Fill in the project name and description.</li>
<li>Then type the repo&#39;s GitHub address into <em>GitHub project</em></li>
<li>Under <em>Source Code Management</em> tick <em>Git</em> and type the repo&#39;s ssh address</li>
<li>For configuring GitHub push with service hooks read <a href="http://blog.cloudbees.com/2012/01/better-integration-between-jenkins-and.html">this</a> and <a href="http://fourkitchens.com/blog/2011/09/20/trigger-jenkins-builds-pushing-github">this</a></li>
<li>If you tick <em>Build when a change is pushed to GitHub</em>, job is built after a commit has been pushed to GitHub. Usually you&#39;ll want to trigger job only on changes in master branch, so type &#39;master&#39; in <em>Branch Specifier</em></li>
</ul>
<p><img src="/blogimages/basics.png" alt="Basic setup">

</p>
<h2>Build actions</h2>
<p>Now you have a job that correctly pulls changes from GitHub after each commit, but it doesn&#39;t yet do anything - so it&#39;s time add a build step

</p>
<ul>
<li>Click <em>Add build step</em> -button. Choose <em>Execute shell</em></li>
</ul>
<p>In this example we want to add a build step to run our unit tests. It&#39;s project dependent how you run your tests, but I recommend keeping most of the logic out of Jenkins e.g. in GNU Makefile. Also choose what kind of output your test runner generates. For example <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP</a> is very simple format with support in many good test runners. As an example the build step could be the following:

</p>
<pre class="highlighted"><code class="haskell"><span class="title">mkdir</span> -p reports
<span class="title">make</span> test <span class="type">REPORTER</span>=tap &gt; reports/test_results.tap</code></pre>
<p>This would first create <em>reports</em> folder under the job&#39;s workspace for outputting all test results (and it&#39;s good to add this folder to <em>.gitignore</em> for running tests locally).

</p>
<p>Now we should be able to run our unit test suite successfully. You can test the build by saving the job and clicking <em>Build Now</em> - button.

</p>
<h2>Post-build actions</h2>
<p>Post-build actions mean stuff that you do after job&#39;s build steps have been completed successfully or failed. For example we would like display test results in the job&#39;s dashboard and email developer if tests failed.

</p>
<ul>
<li>click <em>Add post-build step</em> and choose <em>Publish TAP results</em></li>
<li>Type in the path for test results&#39; tap file</li>
<li>click <em>Add post-build step</em> and choose <em>E-mail notification</em> choose <em>Send separate e-mails to individuals who broke the build</em> and make sure you&#39;ve configured developers email addresses in user management.</li>
</ul>
<p><img src="/blogimages/tap-results.png" alt="TAP results">

</p>
<h2>Code coverage reports</h2>
<p>There&#39;s many different code coverage plugins for Jenkins, but if found the Cobertura plugin and <a href="https://github.com/gotwarlost/istanbul">Istanbul</a> to be the nicest fit for our use. We using Mocha testing framework, so we need <a href="https://github.com/arikon/mocha-istanbul">mocha-istanbul</a> to generate coverage report with mocha.

</p>
<p>Here&#39;s the relevant parts from our makefile

</p>
<pre class="highlighted"><code class="cmake">BIN = ./node_modules/.bin
UNIT_TESTS = $(shell find test -name '*.test.js')
INSTRUMENTATION_OUTPUT = build/lib-cov
REPORTS = reports

instrument: clean-coverage
    $(BIN)/istanbul instrument --output $(INSTRUMENTATION_OUTPUT) --no-compact \ 
        --variable global.__coverage__ lib

<span class="comment"># run tests with instrumented code</span>
coverage: instrument
    @ISTANBUL_REPORTERS=html,text-summary,cobertura EXPRESS_COV=<span class="number">1</span> \
        $(BIN)/mocha --bail --reporter mocha-istanbul $(UNIT_TESTS)
    $(MAKE) move-reports

move-reports:
    -mkdir -p reports
    -mv cobertura-coverage.xml reports
    -cp -r html-report reports/
    -rm -rf html-report

clean-coverage:
    -rm -rf $(INSTRUMENTATION_OUTPUT)
    -rm -rf $(REPORTS)</code></pre>
<p>As you see we are generating both cobertura report and html report. Html report is needed because cobertura plugin doesn&#39;t provide very good drill down view all the way until code level. We want to be able to see in each code file which code lines get executed. Istanbul&#39;s html reports provide that, but you need to add a separate post-build job for viewing the results in Jenkins:

</p>
<ul>
<li>click <em>Add post-build step</em> and choose <em>Publish HTML reports</em> put &#39;reports/html-report&#39; as directory to archive.</li>
</ul>
<p><img src="/blogimages/coverage.png" alt="Coverage">

</p>
<p>Here you can see an example of code file with untested lines marked with red. Quite nice way to see where you should add more tests.

</p>
<h2>Static code analysis &amp; style check</h2>
<p>We want to use JSHint to check our code for errors and style. We are running JSHint before our unit tests run, so in case of error it&#39;s spotted on unit testing build step. You can also view JSHint results in Jenkins using <em>Report violations</em> plugin with:

</p>
<pre class="highlighted"><code class="cmake">lint-report:
    $(BIN)/jshint --config $(JSHINT_CONFIG) \
        --jslint-reporter \
        $(SRC_FILES) \
        &gt; reports/jslint.xml || true</code></pre>
<p>This is best done as a separate build step, where you call above makefile target and then create a post-build step with <em>Report violations</em> plugin and put the jslint pattern in place.

</p>
<p>You can also check style with:

</p>
<pre class="highlighted"><code class="cmake">style-report:
    $(BIN)/jshint --config $(JSHINT_CONFIG) \
        --checkstyle-reporter \
        $(SRC_FILES) \
        &gt; reports/checkstyle-jshint.xml || true</code></pre>
<p>And view reports with <em>Publish Checkstyle analysis results</em> post-build step.

</p>
<h2>Publishing custom images</h2>
<p>If you&#39;re running browser tests, it might be a good idea to take screenshots on failed builds to make it easier to find out where build failed or just to check that layout looks correct. To do that you might want to use Flexible Publish Plugin:

</p>
<ul>
<li>click <em>Add post-build step</em> and choose <em>Flexible publish</em></li>
<li>choose <em>Archive the artifacts</em> and fill the path where images get saved (&#39;reports/*.png&#39; in our case)</li>
</ul>
<h2>Handling project dependencies</h2>
<p>Our example project actually consists of several different smaller projects: we have multiple backends that provide APIs for our frontend code. We want to be able to run our end-to-end tests against real server so we have to make sure that when code is pushed in the dependent repos, we deploy the newest code in our test server and run our end-to-end tests.

</p>
<p>Jenkins has a <em>Join plugin</em>, which helps you decouple your jobs into smaller sub-jobs. You can use it to add post-build step <em>Build other projects</em>, where you can specify jobs to run after current job is finished. It also has <em>Join trigger</em> for specifying jobs that are built after jobs specified in &#39;Build other projects&#39; are done.

</p>
<h3>Example test flow</h3>
<p>We have the following jobs:

</p>
<h4>test-suite</h4>
<ul>
<li>gets triggered after GitHub push</li>
<li>only acts as mediator for triggering other builds</li>
<li>triggers jobs: unit-tests &amp; deploy</li>
</ul>
<h4>unit-tests</h4>
<ul>
<li>job for running unit tests</li>
<li>handles reporting for failures</li>
</ul>
<h4>deploy</h4>
<ul>
<li>deploys the app and triggers job e2e-tests after done</li>
</ul>
<h4>e2e-tests</h4>
<ul>
<li>job for running end-to-end-tests</li>
<li>end-to-end tests are run against server specified in &#39;deploy-api&#39;</li>
</ul>
<h4>deploy-api</h4>
<ul>
<li>deploys backend API code to test server after GitHub commit</li>
</ul>
<p>There&#39;s no bi-directional dependencies yet so if API code gets changed, it doesn&#39;t trigger test flow for client code. It would be easy to add this in similar way.</p>
</div><p class="postmeta"><span>Posted by Mikko Lehtinen</span><date>Jan 31 2013</date><span class="tags">Jenkins,testing</span></p><div class="sharing"><a href="https://twitter.com/share" data-via="kosmikko" data-related="kosmikko" class="twitter-share-button">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></div></article></section></article><aside id="sidebar"><section id="recent-posts"><h2>Recent posts</h2><ul><li><a href="/blog/2013-01-31-jenkins-setup-for-a-javascript-project">Jenkins setup for a JavaScript project</a></li><li><a href="/blog/2013/01/13/new-mac-setup/">Setting up a new Mac</a></li><li><a href="/blog/2012/08/03/structuring-complex-backbone-dot-js-apps/">Structuring complex Backbone.js apps</a></li><li><a href="/blog/2012/07/10/using-gnu-make-as-frontend-build-tool/">Using GNU Make as a frontend build tool</a></li><li><a href="/blog/2012/06/30/extending-backbone-views-using-mixins/">Extending Backbone views using mixins</a></li><li><a href="/blog/2012/05/25/rewindy-tech-stack/">Rewindy tech stack</a></li><li><a href="/blog/2012-05-16-migrated-to-octopress">Migrated to Octopress</a></li><li><a href="/blog/2010-11-05-cross-browser-buttons-with-css3-and-sass">Cross-browser buttons with CSS3 and Sass</a></li><li><a href="/blog/2010-10-28-app-engine-helpers-for-zsh">App Engine helpers for ZSH</a></li><li><a href="/blog/2010-10-26-markup-enabled-notational-velocity">Markup-enabled Notational Velocity</a></li><li><a href="/blog/2010-10-15-programmers-keyboard-layout">Programmer's keyboard layout</a></li><li><a href="/blog/2010-10-01-improving-kindle3-experience">Improving Kindle3 experience</a></li><li><a href="/blog/2010-09-24-osx-zsh-magic">OSX ZSH magic</a></li><li><a href="/blog/2010-09-24-decorator-for-executing-a-function-in-a-given-namespace">Decorator for executing a function in a given namespace</a></li></ul></section><section id="tweets"><h2>Latest tweets</h2><li><datetime>Jan 31 2013</datetime><a href="https://twitter.com/#!/kosmikko/status/297041034569981953" title="View on Twitter">Jenkins setup for a JavaScript project http://t.co/V1OoiA5x</a></li><li><datetime>Jan 29 2013</datetime><a href="https://twitter.com/#!/kosmikko/status/296254455345737728" title="View on Twitter">Full-Spectrum Testing with AngularJS and Testacular http://t.co/6Zr6w1aE</a></li><li><datetime>Jan 29 2013</datetime><a href="https://twitter.com/#!/kosmikko/status/296176247141195776" title="View on Twitter">gr8, sublime text 3 beta available for reg users http://t.co/a8iJpU3u</a></li><li><datetime>Jan 28 2013</datetime><a href="https://twitter.com/#!/kosmikko/status/295891774524755968" title="View on Twitter">Helium - A minimal &amp; responsive frontend framework based on Bootstrap &amp; Foundation https://t.co/IFURd0Tq</a></li><li><datetime>Jan 28 2013</datetime><a href="https://twitter.com/#!/kosmikko/status/295885167917158401" title="View on Twitter">kelly norton: On Layout &amp; Web Performance http://t.co/Aa4lqWj2 via @kellegous</a></li></section></aside><!-- Scripts--></body></html>